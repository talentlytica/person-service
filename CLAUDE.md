# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Build and Test Commands

```bash
# Setup
make install        # Verify dependencies (Go 1.24+, Docker, Node.js, npm, Python3)
make build          # Build Docker image and install npm dependencies

# Testing
make test           # Full test suite (build + tests)
make test-only      # Run tests without rebuilding
make test-unit      # Go unit tests only
make test-coverage  # Tests with coverage collection
make merge-coverage # Merge unit + integration coverage
make serve-coverage # View coverage report at http://localhost:8181/report.html

# Running
docker compose -f source/docker-compose.yml up  # Start backend
make webui                                       # Start backend + Web UI
make webui-down                                  # Stop Web UI services
```

## Architecture

**Three-Layer Architecture** (strictly enforced):

1. **Logic Layer** (`source/app/*/`): Pure business logic. Deterministic, no side effects, no external dependencies.

2. **I/O Layer** (`source/app/main.go`, handlers): HTTP orchestration only. Early returns/guard clauses only - no complex loops or business logic.

3. **Dependencies Layer** (`source/app/internal/db/generated/`): SQLC-generated database code. PostgreSQL with pgx v5.

**Key Modules:**
- `healthcheck/`: Health monitoring (`GET /health`)
- `key_value/`: Key-value CRUD (`POST|GET|DELETE /api/key-value/:key`)
- `person_attributes/`: Encrypted person attributes (`/persons/:personId/attributes[/:attributeId]`) - requires API key
- `middleware/`: API key validation (blue/green rotation pattern)

**Environment Variables:**
- `DATABASE_URL`: PostgreSQL connection string
- `PORT`: Server port (default 3000)
- `ENCRYPTION_KEY_1`: Encryption key for sensitive data
- `PERSON_API_KEY_BLUE` / `PERSON_API_KEY_GREEN`: API keys (format: `person-service-key-<UUID>`)

## Testing Architecture

- **Integration Tests**: Jest + Gherkin/Cucumber in `specs/`
  - Feature files: `specs/features/*.feature`
  - Step definitions: `specs/steps/*.steps.js`
  - Test environment setup: `specs/setup/test-environment.js`
- **Unit Tests**: Go native testing in `source/app/**/*_test.go`
- **Mutation Testing**: Gremlins framework (96% test efficacy)

**Testing Constraints (from .cursorrules):**
- Tests must call via HTTP endpoints, not direct Logic Layer methods
- Allowed: Assertions, API calls, DB queries, headless browsing
- Forbidden: Direct logic layer calls, complex transformations in tests

## Code Generation

Database queries are generated by SQLC:
- Schema: `source/app/internal/db/schema.sql`
- Queries: `source/app/internal/db/queries.sql`
- Config: `source/app/internal/db/sqlc.yaml`
- Generated: `source/app/internal/db/generated/`

## Architectural Rules

From `.cursorrules`:
- **No loops** (`for`, `while`, `do-while`, recursion) in I/O or Dependencies layers
- **No business logic** in I/O layer - only early returns for validation
- **Push all logic** to Logic Layer
- **Dependency inversion**: Logic Layer defines interfaces, Dependencies Layer implements them

**Code Generation Workflow:**
1. Define types/interfaces (Logic Layer)
2. Implement logic methods (Logic Layer)
3. Implement dependencies (Dependencies Layer)
4. Wire handlers (I/O Layer)

## API Documentation

- OpenAPI spec: `source/docs/openapi.yaml`
- Interactive docs: `source/docs/swagger-ui.html`
- API definition: `source/docs/api_definition.md`
